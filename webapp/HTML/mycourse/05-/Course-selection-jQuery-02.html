<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course selection</title>
    <style>
        *{
        padding: 0;
        margin: 0 auto;
        box-sizing: border-box;
        }
    body{
        width: 80%;
        text-align: center;
    }
    h1{
        font-size: 2rem;
        margin: 1.5rem 0;
        }
    table{
        width: 100%;
        border: none;
        margin: 2rem 0;
        border-collapse: collapse;
        }
    thead{
        height: 3rem;
        background-color: green;
    }
    tbody{

    }
    tr{
        height: 3rem;
        transition:all 0.5s ease;
    }
    td{
    
    }
    button{
        width: 1.5rem;
        height: 1.5rem;
    }
    tbody tr:hover{
        background-color: #cccccc;
        transition:all 0.3s ease;
    }
    </style>
    </head>
    <body>
        <table>
        <thead>
            <tr>
                <th>#</th>
                <th>名称</th>               
                <th>学分</th>
                <th>起始周</th>
                <th>时间</th>
                <th>教师</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
    $(function(){
        const courses = [
        {
            id : '1',
            name : '数据库原理',
            credit:3,
            startWeek:1,
            endWeek:10,
            day:1,
            section:12,
            teacher:'刘丹'
        },
        {
            id : '2',
            name : 'Web开发技术',
            credit:2.5,
            startWeek:1,
            endWeek:8,
            day:1,
            section:34,
            teacher:'王波'
        },
        {
            id : '3',
            name : '托福阅读',
            credit:2,
            startWeek:1,
            endWeek:5,
            day:1,
            section:12,
            teacher:'李景阳'
        },
        {
            id : '4',
            name : '高级英语试听',
            credit:2,
            startWeek:3,
            endWeek:10,
            day:1,
            section:34,
            teacher:'龙超越'
        },
        {
            id : '5',
            name : 'Web系统框架',
            credit:2.5,
            startWeek:10,
            endWeek:17,
            day:1,
            section:12,         
            teacher:'王子阳'
        },
        {
            id : '6',
            name : '算法设计与分析',
            credit:2,
            startWeek:6,
            endWeek:10,
            day:1,
            section:12,       
            teacher:'谷志新'
        }
    ]
    //将数组写入HTML中 模板字符串     
    const rows = courses.map((course,index) => 
    `<tr data-row-index="${index + 1}">
            <td>${course.id}</td>
            <td>${course.name}</td>
            <td>${course.credit}</td>
            <td>${course.startWeek} - ${course.endWeek}</td>
            <td>周${course.day} / ${course.section}节</td>
            <td>${course.teacher}</td>
            <td><input type="checkbox" class="mayConflict-checkbox" name="courses" value="${course.id}"></td>
        </tr>
    `)
    $('table tbody').html(rows.join(''));//生成的所有行连接成一个大的字符串，以便一次性插入到tbody中
   
    const checkedCourse = [] //课程是否被点过的数组
    $('.mayConflict-checkbox').click(function(event) { 
        const courseId = $(this).val()
        if(!checkedCourse.includes(courseId))  //检查当前对象是否点击过
        {
        checkedCourse.push(courseId)
        console.log(checkedCourse)
        ConflictCourse(courseId)
    }
    counter(courseId,event)
    })

    let conflictCourse = new Map()//储存点击之后各个课程冲突的课程 键为id值，为冲突数组，数组里有冲突的课程id和行数
    const ConflictCourse = (cId) => {
        const course = courses.find(c => c.id===cId)
        const conflictingCourse = courses
        .filter(c => c.id !== course.id)
        .filter(c => {
            const weekConflict = (c.startWeek <= course.endWeek && c.endWeek >= course.startWeek) ||
                                (c.startWeek <= course.startWeek && c.endWeek >= course.endWeek) ||
                                (c.startWeek >= course.startWeek && c.endWeek <= course.endWeek);
            return weekConflict && c.day === course.day && c.section === course.section})
        .map(c =>{
            const $row = $(`tr[data-row-index='${c.id}']`).data('row-index')
            return{ courseId: c.id, row : $row } // 返回一个对象，包含课程ID和行位置
        })
        //console.log(conflictingCourse);
        conflictCourse.set(course.id,conflictingCourse)
    }
    console.log(conflictCourse)

    //分析：应该把计数器放哪？如果放在点击数组里，则找不到冲突课程，无法对已冲突的课程+1/-1
    //如果放在map集合里，每门课对应的冲突课固定，点击时可以取到这些课，但是对每门冲突课进行计数加减，需要整合这些课的计数，而且一直改
    //放在课程数组的属性上，一旦有冲突课程，直接对属性值进行增减
    //放在一个新数组中，索引+1为冲突课程的行号，数组中数值增减
    let counterCount = new Array(courses.length+1).fill(0) //第0位不用
    const counter = (cId,event) => {
    const conflictingCourses = conflictCourse.get(cId) //Map的get,set方法
    if (conflictingCourses) {
        conflictingCourses.forEach(conflict => {
            const index = conflict.row
            //const checkbox = $(`tr[data-row-index='${index}'] input[type='checkbox']`);
            if (event.target.checked) {//如果用checkbox.is(':checked')?
                counterCount[index]++
            } 
            else{
                counterCount[index]--
            }
        })
    }
    counterCount.forEach((count, index) => {
        const checkbox = $(`tr[data-row-index='${index}'] input[type='checkbox']`)
        if (count > 0) {
            checkbox.prop('disabled', true)
        } else {
            checkbox.prop('disabled', false)
        }
    })
}
})
</script>
<!-- 
总结：
    ·tr[data-row-index='${c.id}']是一个jQuery选择器，它选取了具有data-row-index属性等于c.id的<tr>元素。
    .data('row-index')尝试读取这个<tr>元素上的data-row-index属性的值。
        需要注意的是，.data()方法会自动处理类型转换。如果你存储的是一个数字，它会返回一个数字；如果是字符串，则返回字符串。
        这使得它比使用.attr()方法更方便，因为.attr()总是返回字符串值，即使原始的data-*属性中存储的是数字或其他类型的数据。
    ·if (event.target.checked) 直接从事件对象中读取触发事件的元素,判断当前点的多选框是否被选中时
        如果用：checkbox.is(':checked')在取消选中时可能不会减少计数。
        原因：if (checkbox.is(':checked'))检查的是checkbox在函数执行时的状态，而并非触发事件时的状态
        此时函数可能在用户取消选择复选框之后才被调用
    
    
    
    -->
</body>
</html>